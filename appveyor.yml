version: 1.0.{build}
image: Visual Studio 2017
platform: Any CPU
clone_depth: 1
init:
- cmd: ''
install:
- cmd: >-
    git submodule update --init --recursive

    set QTDIR=C:\Qt\5.11\msvc2017_64

    set PATH=%PATH%;%QTDIR%\bin

    call "C:\Program Files (x86)\Microsoft Visual Studio\2017\Community\VC\Auxiliary\Build\vcvarsall.bat" x64
build_script:
- cmd: >-
    curl -fsS -o openssl.7z https://pajlada.se/files/openssl.7z

    7z x openssl.7z

    dir

    mkdir build

    cd build

    qmake ../chatterino.pro BOOST_DIRECTORY="C:\Libraries\boost_1_64_0" BOOST_LIB_SUFFIX="lib64-msvc-14.1" OPENSSL_DIRECTORY="%APPVEYOR_BUILD_FOLDER%\openssl"  DEFINES+="CHATTERINO_NIGHTLY_VERSION_STRING=\\\"$$system(git describe --always)-$$system(git rev-list master --count)\\\""

    set cl=/MP

    nmake /S /NOLOGO

    git clone https://github.com/pajlada/chatterino2-dlls.git

    mkdir Chatterino2

    cp ../openssl/bin/libcrypto*.dll ../openssl/bin/libssl*.dll Chatterino2/

    cp chatterino2-dlls/*.dll Chatterino2/

    windeployqt release/chatterino.exe --release --no-compiler-runtime --no-translations --no-opengl-sw --dir Chatterino2/

    cp release/chatterino.exe Chatterino2/

    7z a chatterino2.zip Chatterino2/
artifacts:
- path: build/chatterino2.zip
  name: chatterino2
before_deploy:
- ps: >-
    $inPath = "chatterino2.zip"

    $outFileName = "chatterino2-v$($env:APPVEYOR_BUILD_VERSION).zip"

    $outPath = "$($outFileName)"


    # cp "$($inPath)" "$($outPath)"

    # Push-AppveyorArtifact "$($outPath)" -FileName $outFileName
deploy:
- provider: GitHub
  tag: nightly-win
  release: nightly-win
  description: 'nightly v$(appveyor_build_version) built $(APPVEYOR_REPO_COMMIT_TIMESTAMP)\nLast change: $(APPVEYOR_REPO_COMMIT_MESSAGE) \n$(APPVEYOR_REPO_COMMIT_MESSAGE_EXTENDED)'
  # GitHub authentication token (auth_token) - OAuth token used for authentication against GitHub API.
  # You can generate Personal API access token at https://github.com/settings/tokens.
  # Minimal token scope is repo or public_repo to release on private or public repositories respectively.
  # Be sure to encrypt your token using “Encrypt configuration data” page in AppVeyor (Settings → Encrypt YAML).
  # See also: https://www.appveyor.com/docs/deployment/github/
  auth_token:
    secure: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
  artifact: build/chatterino2.zip
  prerelease: true
  force_update: true
after_deploy:
- cmd: >-
    REM git tag -f nightly-win %APPVEYOR_REPO_COMMIT%

    REM git push --force origin refs/tags/nightly-win
