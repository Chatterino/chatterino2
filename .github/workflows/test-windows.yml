---
name: Test Windows

on:
  pull_request:
  workflow_dispatch:
  merge_group:

env:
  TWITCH_PUBSUB_SERVER_IMAGE: ghcr.io/chatterino/twitch-pubsub-server-test:v1.0.6
  QT_QPA_PLATFORM: minimal
  # Last known good conan version
  # 2.0.3 has a bug on Windows (conan-io/conan#13606)
  CONAN_VERSION: 2.0.2

concurrency:
  group: test-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test-windows:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: "windows-latest"
            qt-version: "5.15.2"
          - os: "windows-latest"
            qt-version: "5.12.12"
          - os: "windows-latest"
            qt-version: "6.2.4"
      fail-fast: false
    env:
      C2_BUILD_WITH_QT6: ${{ startsWith(matrix.qt-version, '6.') && 'ON' || 'OFF' }}
      QT_MODULES: ${{ startsWith(matrix.qt-version, '6.') && 'qt5compat qtimageformats' || '' }}

    steps:
      - name: Set environment variables for windows-latest
        if: matrix.os == 'windows-latest'
        run: |
          echo "vs_version=2022" >> "$GITHUB_ENV"
        shell: bash

      - name: Set BUILD_WITH_QT6
        if: startsWith(matrix.qt-version, '6.')
        run: |
          echo "C2_BUILD_WITH_QT6=ON" >> "$GITHUB_ENV"
        shell: bash

      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Qt
        uses: jurplel/install-qt-action@v3.3.0
        with:
          cache: true
          cache-key-prefix: ${{ runner.os }}-QtCache-${{ matrix.qt-version }}-v2
          modules: ${{ env.QT_MODULES }}
          version: ${{ matrix.qt-version }}

      - name: Enable Developer Command Prompt
        if: startsWith(matrix.os, 'windows')
        uses: ilammy/msvc-dev-cmd@v1.12.1

      - name: Setup conan variables
        if: startsWith(matrix.os, 'windows')
        run: |
          "C2_USE_OPENSSL3=$(if ($Env:C2_BUILD_WITH_QT6 -eq "on") { "True" } else { "False" })" >> "$Env:GITHUB_ENV"
          "C2_CONAN_CACHE_SUFFIX=$(if ($Env:C2_BUILD_WITH_QT6 -eq "on") { "-QT6" } else { "`" })" >> "$Env:GITHUB_ENV"
        shell: powershell

      - name: Setup sccache
        # sccache v0.5.3
        uses: nerixyz/ccache-action@9a7e8d00116ede600ee7717350c6594b8af6aaa5
        if: startsWith(matrix.os, 'windows')
        with:
          variant: sccache
          # only save on the default (master) branch
          save: ${{ github.event_name == 'push' }}
          key: sccache-test-${{ matrix.os }}-${{ matrix.qt-version }}
          restore-keys: |
            sccache-test-${{ matrix.os }}-${{ matrix.qt-version }}

      - name: Cache conan packages
        if: startsWith(matrix.os, 'windows')
        uses: actions/cache@v3
        with:
          key: ${{ runner.os }}-conan-user-${{ hashFiles('**/conanfile.py') }}${{ env.C2_CONAN_CACHE_SUFFIX }}
          path: ~/.conan2/

      - name: Install Conan
        if: startsWith(matrix.os, 'windows')
        run: |
          python3 -c "import site; import sys; print(f'{site.USER_BASE}\\Python{sys.version_info.major}{sys.version_info.minor}\\Scripts')" >> "$GITHUB_PATH"
          pip3 install --user "conan==${{ env.CONAN_VERSION }}"

      - name: Setup Conan
        if: startsWith(matrix.os, 'windows')
        run: |
          conan --version
          conan profile detect -f

      - name: Create build directory
        if: startsWith(matrix.os, 'windows')
        run: |
          mkdir build-test
        shell: bash

      - name: Install dependencies
        if: startsWith(matrix.os, 'windows')
        run: |
          cd build-test
          conan install .. `
              -s build_type=RelWithDebInfo `
              -c tools.cmake.cmaketoolchain:generator="NMake Makefiles" `
              -b missing `
              --output-folder=. `
              -o with_openssl3="$Env:C2_USE_OPENSSL3"

      - name: Build
        if: startsWith(matrix.os, 'windows')
        shell: pwsh
        env:
          # Enable PCH on Windows
          C2_WINDOWS_USE_PCH: True
        run: |
          cmake -G"NMake Makefiles" -DBUILD_TESTS=On -DBUILD_APP=OFF -DBUILD_WITH_QT6="$C2_BUILD_WITH_QT6" ..
          set cl=/MP
          nmake /S /NOLOGO
        working-directory: build-test

      - name: Test
        if: startsWith(matrix.os, 'windows')
        timeout-minutes: 30
        run: |
          docker pull kennethreitz/httpbin
          docker pull ${{ env.TWITCH_PUBSUB_SERVER_IMAGE }}
          docker run --network=host --detach ${{ env.TWITCH_PUBSUB_SERVER_IMAGE }}
          docker run -p 9051:80 --detach kennethreitz/httpbin
          ./bin/chatterino-test.exe || ./bin/chatterino-test.exe || ./bin/chatterino-test.exe
        working-directory: build-test
        shell: pwsh
