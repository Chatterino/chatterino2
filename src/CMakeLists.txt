include(SourceFileUtils)

project(chatterino)

set(SOURCE_FILES main.cpp
        Application.{hpp,cpp}
        BaseSettings.{hpp,cpp}
        BaseTheme.{hpp,cpp}
        BrowserExtension.{hpp,cpp}
        RunGui.{hpp,cpp}
        autogenerated/ResourcesAutogen.{hpp,cpp}
        common/Args.{hpp,cpp}
        common/Channel.{hpp,cpp}
        common/ChannelChatters.{hpp,cpp}
        common/ChatterinoSetting.{hpp,cpp}
        common/CompletionModel.{hpp,cpp}
        common/Credentials.{hpp,cpp}
        common/DownloadManager.{hpp,cpp}
        common/Env.{hpp,cpp}
        common/LinkParser.{hpp,cpp}
        common/Modes.{hpp,cpp}
        common/NetworkManager.{hpp,cpp}
        common/NetworkPrivate.{hpp,cpp}
        common/NetworkRequest.{hpp,cpp}
        common/NetworkResult.{hpp,cpp}
        common/QLogging.{hpp,cpp}
        common/UsernameSet.{hpp,cpp}
        common/Version.{hpp,cpp}
        common/WindowDescriptors.{hpp,cpp}
        controllers/accounts/Account.{hpp,cpp}
        controllers/accounts/AccountController.{hpp,cpp}
        controllers/accounts/AccountModel.{hpp,cpp}
        controllers/commands/Command.{hpp,cpp}
        controllers/commands/CommandController.{hpp,cpp}
        controllers/commands/CommandModel.{hpp,cpp}
        controllers/filters/FilterModel.{hpp,cpp}
        controllers/filters/parser/FilterParser.{hpp,cpp}
        controllers/filters/parser/Tokenizer.{hpp,cpp}
        controllers/filters/parser/Types.{hpp,cpp}
        controllers/highlights/HighlightBlacklistModel.{hpp,cpp}
        controllers/highlights/HighlightModel.{hpp,cpp}
        controllers/highlights/HighlightPhrase.{hpp,cpp}
        controllers/highlights/UserHighlightModel.{hpp,cpp}
        controllers/ignores/IgnoreModel.{hpp,cpp}
        controllers/moderationactions/ModerationAction.{hpp,cpp}
        controllers/moderationactions/ModerationActionModel.{hpp,cpp}
        controllers/notifications/NotificationController.{hpp,cpp}
        controllers/notifications/NotificationModel.{hpp,cpp}
        controllers/pings/MutedChannelModel.{hpp,cpp}
        controllers/taggedusers/TaggedUser.{hpp,cpp}
        controllers/taggedusers/TaggedUsersModel.{hpp,cpp}
        debug/Benchmark.{hpp,cpp}
        messages/Emote.{hpp,cpp}
        messages/Image.{hpp,cpp}
        messages/ImageSet.{hpp,cpp}
        messages/Link.{hpp,cpp}
        messages/Message.{hpp,cpp}
        messages/MessageBuilder.{hpp,cpp}
        messages/MessageColor.{hpp,cpp}
        messages/MessageContainer.{hpp,cpp}
        messages/MessageElement.{hpp,cpp}
        messages/SharedMessageBuilder.{hpp,cpp}
        messages/layouts/MessageLayout.{hpp,cpp}
        messages/layouts/MessageLayoutContainer.{hpp,cpp}
        messages/layouts/MessageLayoutElement.{hpp,cpp}
        messages/search/AuthorPredicate.{hpp,cpp}
        messages/search/LinkPredicate.{hpp,cpp}
        messages/search/SubstringPredicate.{hpp,cpp}
        providers/IvrApi.{hpp,cpp}
        providers/LinkResolver.{hpp,cpp}
        providers/bttv/BttvEmotes.{hpp,cpp}
        providers/bttv/LoadBttvChannelEmote.{hpp,cpp}
        providers/chatterino/ChatterinoBadges.{hpp,cpp}
        providers/colors/ColorProvider.{hpp,cpp}
        providers/emoji/Emojis.{hpp,cpp}
        providers/ffz/FfzBadges.{hpp,cpp}
        providers/ffz/FfzEmotes.{hpp,cpp}
        providers/irc/AbstractIrcServer.{hpp,cpp}
        providers/irc/Irc2.{hpp,cpp}
        providers/irc/IrcAccount.{hpp,cpp}
        providers/irc/IrcChannel2.{hpp,cpp}
        providers/irc/IrcCommands.{hpp,cpp}
        providers/irc/IrcConnection2.{hpp,cpp}
        providers/irc/IrcMessageBuilder.{hpp,cpp}
        providers/irc/IrcServer.{hpp,cpp}
        providers/twitch/ChannelPointReward.{hpp,cpp}
        providers/twitch/IrcMessageHandler.{hpp,cpp}
        providers/twitch/PubsubActions.{hpp,cpp}
        providers/twitch/PubsubClient.{hpp,cpp}
        providers/twitch/PubsubHelpers.{hpp,cpp}
        providers/twitch/TwitchAccount.{hpp,cpp}
        providers/twitch/TwitchAccountManager.{hpp,cpp}
        providers/twitch/TwitchBadge.{hpp,cpp}
        providers/twitch/TwitchBadges.{hpp,cpp}
        providers/twitch/TwitchChannel.{hpp,cpp}
        providers/twitch/TwitchEmotes.{hpp,cpp}
        providers/twitch/TwitchHelpers.{hpp,cpp}
        providers/twitch/TwitchIrcServer.{hpp,cpp}
        providers/twitch/TwitchMessageBuilder.{hpp,cpp}
        providers/twitch/TwitchParseCheerEmotes.{hpp,cpp}
        providers/twitch/TwitchUser.{hpp,cpp}
        providers/twitch/api/Helix.{hpp,cpp}
        providers/twitch/api/Kraken.{hpp,cpp}
        singletons/Badges.{hpp,cpp}
        singletons/Emotes.{hpp,cpp}
        singletons/Fonts.{hpp,cpp}
        singletons/Logging.{hpp,cpp}
        singletons/NativeMessaging.{hpp,cpp}
        singletons/Paths.{hpp,cpp}
        singletons/Resources.{hpp,cpp}
        singletons/Settings.{hpp,cpp}
        singletons/Theme.{hpp,cpp}
        singletons/Toasts.{hpp,cpp}
        singletons/TooltipPreviewImage.{hpp,cpp}
        singletons/Updates.{hpp,cpp}
        singletons/WindowManager.{hpp,cpp}
        singletons/helper/GifTimer.{hpp,cpp}
        singletons/helper/LoggingChannel.{hpp,cpp}
        util/Clipboard.{hpp,cpp}
        util/DebugCount.{hpp,cpp}
        util/FormatTime.{hpp,cpp}
        util/FunctionEventFilter.{hpp,cpp}
        util/FuzzyConvert.{hpp,cpp}
        util/Helpers.{hpp,cpp}
        util/IncognitoBrowser.{hpp,cpp}
        util/InitUpdateButton.{hpp,cpp}
        util/JsonQuery.{hpp,cpp}
        util/LayoutHelper.{hpp,cpp}
        util/NuulsUploader.{hpp,cpp}
        util/RapidjsonHelpers.{hpp,cpp}
        util/StreamLink.{hpp,cpp}
        util/StreamerMode.{hpp,cpp}
        util/Twitch.{hpp,cpp}
        util/WindowsHelper.{hpp,cpp}
        widgets/AccountSwitchPopup.{hpp,cpp}
        widgets/AccountSwitchWidget.{hpp,cpp}
        widgets/AttachedWindow.{hpp,cpp}
        widgets/BasePopup.{hpp,cpp}
        widgets/BaseWidget.{hpp,cpp}
        widgets/BaseWindow.{hpp,cpp}
        widgets/Label.{hpp,cpp}
        widgets/Notebook.{hpp,cpp}
        widgets/Scrollbar.{hpp,cpp}
        widgets/StreamView.{hpp,cpp}
        widgets/TooltipWidget.{hpp,cpp}
        widgets/Window.{hpp,cpp}
        widgets/dialogs/ChannelFilterEditorDialog.{hpp,cpp}
        widgets/dialogs/ColorPickerDialog.{hpp,cpp}
        widgets/dialogs/EmotePopup.{hpp,cpp}
        widgets/dialogs/IrcConnectionEditor.{hpp,cpp}
        widgets/dialogs/LastRunCrashDialog.{hpp,cpp}
        widgets/dialogs/LoginDialog.{hpp,cpp}
        widgets/dialogs/NotificationPopup.{hpp,cpp}
        widgets/dialogs/QualityPopup.{hpp,cpp}
        widgets/dialogs/SelectChannelDialog.{hpp,cpp}
        widgets/dialogs/SelectChannelFiltersDialog.{hpp,cpp}
        widgets/dialogs/SettingsDialog.{hpp,cpp}
        widgets/dialogs/TextInputDialog.{hpp,cpp}
        widgets/dialogs/UpdateDialog.{hpp,cpp}
        widgets/dialogs/UserInfoPopup.{hpp,cpp}
        widgets/dialogs/WelcomeDialog.{hpp,cpp}
        widgets/dialogs/switcher/NewTabItem.{hpp,cpp}
        widgets/dialogs/switcher/QuickSwitcherModel.{hpp,cpp}
        widgets/dialogs/switcher/QuickSwitcherPopup.{hpp,cpp}
        widgets/dialogs/switcher/SwitchSplitItem.{hpp,cpp}
        widgets/helper/Button.{hpp,cpp}
        widgets/helper/ChannelView.{hpp,cpp}
        widgets/helper/ColorButton.{hpp,cpp}
        widgets/helper/ComboBoxItemDelegate.{hpp,cpp}
        widgets/helper/DebugPopup.{hpp,cpp}
        widgets/helper/EditableModelView.{hpp,cpp}
        widgets/helper/EffectLabel.{hpp,cpp}
        widgets/helper/NotebookButton.{hpp,cpp}
        widgets/helper/NotebookTab.{hpp,cpp}
        widgets/helper/QColorPicker.{hpp,cpp}
        widgets/helper/ResizingTextEdit.{hpp,cpp}
        widgets/helper/ScrollbarHighlight.{hpp,cpp}
        widgets/helper/SearchPopup.{hpp,cpp}
        widgets/helper/SettingsDialogTab.{hpp,cpp}
        widgets/helper/SignalLabel.{hpp,cpp}
        widgets/helper/TitlebarButton.{hpp,cpp}
        widgets/listview/GenericItemDelegate.{hpp,cpp}
        widgets/listview/GenericListItem.{hpp,cpp}
        widgets/listview/GenericListModel.{hpp,cpp}
        widgets/listview/GenericListView.{hpp,cpp}
        widgets/settingspages/AboutPage.{hpp,cpp}
        widgets/settingspages/AccountsPage.{hpp,cpp}
        widgets/settingspages/CommandPage.{hpp,cpp}
        widgets/settingspages/ExternalToolsPage.{hpp,cpp}
        widgets/settingspages/FiltersPage.{hpp,cpp}
        widgets/settingspages/GeneralPage.{hpp,cpp}
        widgets/settingspages/GeneralPageView.{hpp,cpp}
        widgets/settingspages/HighlightingPage.{hpp,cpp}
        widgets/settingspages/IgnoresPage.{hpp,cpp}
        widgets/settingspages/KeyboardSettingsPage.{hpp,cpp}
        widgets/settingspages/ModerationPage.{hpp,cpp}
        widgets/settingspages/NotificationPage.{hpp,cpp}
        widgets/settingspages/SettingsPage.{hpp,cpp}
        widgets/splits/ClosedSplits.{hpp,cpp}
        widgets/splits/EmoteInputItem.{hpp,cpp}
        widgets/splits/EmoteInputPopup.{hpp,cpp}
        widgets/splits/Split.{hpp,cpp}
        widgets/splits/SplitContainer.{hpp,cpp}
        widgets/splits/SplitHeader.{hpp,cpp}
        widgets/splits/SplitInput.{hpp,cpp}
        widgets/splits/SplitOverlay.{hpp,cpp}
        widgets/dialogs/IrcConnectionEditor.ui
        ${CMAKE_SOURCE_DIR}/resources/resources.qrc
        ${CMAKE_SOURCE_DIR}/resources/resources_autogenerated.qrc
        )

if (WIN32)
    # clang-cl doesn't support resource files
    if (NOT CMAKE_CXX_COMPILER_ID MATCHES "Clang")
        list(APPEND SOURCE_FILES "${CMAKE_SOURCE_DIR}/resources/windows.rc")
    endif ()

elseif (APPLE)
    list(APPEND SOURCE_FILES "${CMAKE_SOURCE_DIR}/resources/chatterino.icns")
endif ()

# Expand file extensions (i.e. path/to/file.{h,cpp} becomes path/to/file.h;path/to/file.cpp)
expand_file_extensions(SOURCE_FILES ${SOURCE_FILES})

# Generate source groups for use in IDEs
generate_source_groups(${SOURCE_FILES})

add_executable(${PROJECT_NAME} ${SOURCE_FILES})

target_compile_definitions(${PROJECT_NAME} PRIVATE
    CHATTERINO
    UNICODE
    AB_CUSTOM_THEME
    AB_CUSTOM_SETTINGS
    IRC_STATIC
    IRC_NAMESPACE=Communi
    )
if (USE_SYSTEM_QT5KEYCHAIN OR USE_PACKAGE_MANAGER)
    target_compile_definitions(${PROJECT_NAME} PRIVATE
        CMAKE_BUILD
        )
endif ()
target_compile_definitions(${PROJECT_NAME} PRIVATE
    CHATTERINO_GIT_HASH=\"${GIT_HASH}\"
    CHATTERINO_GIT_RELEASE=\"${GIT_RELEASE}\"
    CHATTERINO_GIT_COMMIT=\"${GIT_COMMIT}\"
    )
if (WIN32)
    target_compile_definitions(${PROJECT_NAME} PRIVATE USEWINSDK)
    set_target_properties(${PROJECT_NAME} PROPERTIES WIN32_EXECUTABLE TRUE)
endif ()

if (MSVC)
    target_compile_options(${PROJECT_NAME} PRIVATE /EHsc)
endif ()

if (APPLE)
    set_target_properties(${PROJECT_NAME} PROPERTIES MACOSX_BUNDLE TRUE)
endif ()

target_include_directories(${PROJECT_NAME} PRIVATE ${CMAKE_CURRENT_SOURCE_DIR})

target_link_libraries(${PROJECT_NAME}
        PRIVATE
        Qt5::Concurrent
        Qt5::Gui
        Qt5::Multimedia
        Qt5::Network
        Qt5::Svg
        Qt5::Widgets
        )

if (WinToast_FOUND)
    target_link_libraries(${PROJECT_NAME}
        PRIVATE
        WinToast)
endif ()

if (USE_PACKAGE_MANAGER)
    target_link_libraries(${PROJECT_NAME}
            PRIVATE
            CONAN_PKG::boost
            CONAN_PKG::communi
            CONAN_PKG::openssl
            CONAN_PKG::QtKeychain
            CONAN_PKG::rapidjson
            CONAN_PKG::serialize
            CONAN_PKG::settings
            CONAN_PKG::signals
            CONAN_PKG::WebSocketpp
            )
else ()
    target_include_directories(${PROJECT_NAME} PRIVATE ${RapidJSON_INCLUDE_DIRS})
    target_link_libraries(${PROJECT_NAME}
            PRIVATE
            Boost::boost
            LibCommuni::LibCommuni
            OpenSSL::SSL
            OpenSSL::Crypto
            qt5keychain
            Pajlada::Serialize
            Pajlada::Settings
            Pajlada::Signals
            websocketpp::websocketpp
            Threads::Threads
            RapidJSON::RapidJSON
            )
        if (LIBRT)
            target_link_libraries(${PROJECT_NAME}
                PRIVATE
                ${LIBRT}
                )
        endif ()
endif ()

target_precompile_headers(${PROJECT_NAME} PRIVATE PrecompiledHeader.hpp)

# ------------------------------------------------------------------------------------------------#
# Cpack
# ------------------------------------------------------------------------------------------------#

set(CPACK_PACKAGE_NAME "Chatterino")
set(CPACK_PACKAGE_DESCRIPTION "Chatterino is a chat client for twitch chat. It aims to be an improved/extended version of the twitch web chat")
set(CPACK_PACKAGE_DESCRIPTION_SUMMARY "Chatterino is a chat client for twitch chat")
set(CPACK_PACKAGE_VERSION ${CHATTERINO2_VERSION})
set(CPACK_RESOURCE_FILE_LICENSE "${CMAKE_SOURCE_DIR}/resources/license.rtf")
set(CPACK_PACKAGE_EXECUTABLES "chatterino" "Chatterino")

set(CPACK_GENERATOR ZIP)

if (MSVC)
    find_program(WINDEPLOYQT_PROGRAM windeployqt)
    get_filename_component(QT_BIN_DIR ${WINDEPLOYQT_PROGRAM} DIRECTORY CACHE)
    set(WINDEPLOYQT_COMAND ${WINDEPLOYQT_PROGRAM} $<TARGET_FILE:${PROJECT_NAME}> --release --no-compiler-runtime --no-translations --no-opengl-sw)

    # Fix for windeployqt not being able to find qt5keychain
    if (USE_PACKAGE_MANAGER AND EXISTS ${RUNTIME_OUTPUT_DIRECTORY}/qt5keychain.dll AND NOT EXISTS ${QT_BIN_DIR}/qt5keychain.dll)
        message("Copying ${RUNTIME_OUTPUT_DIRECTORY}/qt5keychain.dll to ${QT_BIN_DIR}")
        file(COPY ${RUNTIME_OUTPUT_DIRECTORY}/qt5keychain.dll DESTINATION ${QT_BIN_DIR})
    endif ()

    add_custom_target(copy_dll
            COMMAND ${WINDEPLOYQT_COMAND}
            WORKING_DIRECTORY ${RUNTIME_OUTPUT_DIRECTORY}
            )

    install(TARGETS ${PROJECT_NAME}
            RUNTIME DESTINATION .
            )

    install(CODE "execute_process(COMMAND ${WINDEPLOYQT_COMAND} --dir \${CMAKE_INSTALL_PREFIX})")

    set(CPACK_PACKAGE_FILE_NAME "chatterino-windows-x86-64")

    #For Windows Desktop shortcuts
    set(CPACK_CREATE_DESKTOP_LINKS "chatterino" "Chatterino 2")

    # Windows Add or Remove Program properties
    set(CPACK_WIX_PROGRAM_MENU_FOLDER "Chatterino 2")
    set(CPACK_WIX_PROPERTY_ARPCOMMENTS "${CPACK_PACKAGE_DESCRIPTION_SUMMARY}")
    set(CPACK_WIX_PROPERTY_ARPURLINFOABOUT "https://chatterino.com/")
    set(CPACK_WIX_PROPERTY_URLUPDATEINFO "https://chatterino.com/")

    set(CPACK_WIX_PRODUCT_ICON "${CMAKE_SOURCE_DIR}/resources/icon.ico")

    set(CPACK_WIX_LICENSE_RTF "${CPACK_RESOURCE_FILE_LICENSE}")
    set(CPACK_WIX_UPGRADE_GUID "f33967d1-0bdd-4a4b-ba1a-d859bce8927a")

    set(CPACK_PACKAGE_INSTALL_DIRECTORY "Chatterino2")
    set(CPACK_GENERATOR ${CPACK_GENERATOR};WIX)
    set(CPACK_MODULE_PATH "")
elseif (APPLE)
    set(CPACK_PACKAGE_FILE_NAME "chatterino-x86-64")
    install(TARGETS ${PROJECT_NAME}
            RUNTIME DESTINATION bin
            BUNDLE DESTINATION bin
            LIBRARY DESTINATION lib
            ARCHIVE DESTINATION lib/static
            )

    set(CPACK_GENERATOR ${CPACK_GENERATOR};DragNDrop)
else ()
    set(CPACK_PACKAGE_FILE_NAME "Chatterino-x86_64")

    install(TARGETS ${PROJECT_NAME}
            RUNTIME DESTINATION bin
            LIBRARY DESTINATION lib
            ARCHIVE DESTINATION lib/static
            )

    install(FILES ${CMAKE_SOURCE_DIR}/resources/com.chatterino.chatterino.desktop
            DESTINATION share/applications
            )

    install(FILES ${CMAKE_SOURCE_DIR}/resources/icon.png
            RENAME com.chatterino.chatterino.png
            DESTINATION share/icons/hicolor/256x256/apps
            )
endif ()

include(CPack)
